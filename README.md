# A Discussion on Keeping the Angle Pseudo Measurement Between (-pi,pi]

Tracking a moving object with an extended Kalman filter is a standard exercise which is widely used in colleges. However, there exists an exciting discussion about the subtraction in the Kalman filter innovation. When the radar data is used to update the estimate, we should subtract the measured angle from the supposed angle, which gives a part of the Kalman innovative. The angle that is supposed to be measured is called pseudo-measurement. The guideline from the Udacity suggests that we should keep the angle pseudo-measurement between <a href="https://www.codecogs.com/eqnedit.php?latex=$\left(&space;-\pi&space;,\pi&space;\right]$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\left(&space;-\pi&space;,\pi&space;\right]$" title="$\left( -\pi ,\pi \right]$" /></a>. We would like to provide an explanation that why it is necessary. 

The variable in innovation should tell the filter whether the measure is bigger or smaller than the pseudo-measurement. If it is bigger, the associated variable in the innovation should be positive. Otherwise, the related variable should be negative. The absolute value of the innovation is not crucial, so long as it is proportionate to the difference between the real measurement and pseudo-measurement. So, everything in the innovation should adequately reflect this information. Furthermore, whether an actual measurement is bigger or smaller than the pseudo-measurement is defined by the user. But, once it is determined, it should be consistent in the working area of the filter. 

One angle subtracts another is equal to the smaller angle which is needed when turning the second vector to the first one. The counter-clockwise turning means positive, and the clockwise turning means negative. 

![image](Docs/Fig1.png)

In the above figure, the vector B performs a counter-clockwise turning until it is overlapped with vector A. The angle through which the vector B turns is the difference, which is positive. Directly subtraction angle B from angle A gives the right result in this condition. The calculation is working. Unfortunately, if two angles in <a href="https://www.codecogs.com/eqnedit.php?latex=$\left(&space;0,2\pi&space;\right]$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\left(&space;0,2\pi&space;\right]$" title="$\left( 0,2\pi \right]$" /></a> are subtracted from one to another, an inappropriate result can be generated. Take the following figure as an example. 

![image](Docs/Fig2.png)

The angle <a href="https://www.codecogs.com/eqnedit.php?latex=$A-B$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$A-B$" title="$A-B$" /></a> is as big as it in the previous figure. However, <a href="https://www.codecogs.com/eqnedit.php?latex=$\angle&space;A\le&space;\pi/2$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\angle&space;A\le&space;\pi/2$" title="$\angle A\le \pi/2$" /></a>, and <a href="https://www.codecogs.com/eqnedit.php?latex=$\angle&space;B\ge&space;{3\pi&space;}/{2}$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\angle&space;B\ge&space;{3\pi&space;}/{2}$" title="$\angle B\ge {3\pi }/{2}$" /></a>. Directly subtracting angle B from angle A gives a negative value, which will misguide the Kalman filter. 

The idea from Udacity is efficient. By converting any angle to <a href="https://www.codecogs.com/eqnedit.php?latex=$\left(&space;-\pi&space;,\pi&space;\right]$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\left(&space;-\pi&space;,\pi&space;\right]$" title="$\left( -\pi ,\pi \right]$" /></a>, the difference of two angles is just appropriate for the filter. However, it is also possible to calculate the smaller angle from vector B to the vector A. 

<a href="https://www.codecogs.com/eqnedit.php?latex=$\angle&space;A-\angle&space;B=\angle&space;A&plus;(-\angle&space;B)$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\angle&space;A-\angle&space;B=\angle&space;A&plus;(-\angle&space;B)$" title="$\angle A-\angle B=\angle A+(-\angle B)$" /></a>

A vector with angle <a href="https://www.codecogs.com/eqnedit.php?latex=$\theta&space;$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\theta&space;$" title="$\theta $" /></a> and length one can be expressed by a rotation matrix <a href="https://www.codecogs.com/eqnedit.php?latex=$R(\theta&space;)=\left[&space;\begin{matrix}&space;\cos&space;(\theta&space;)&space;&&space;-\sin&space;(\theta&space;)&space;\\&space;\sin&space;(\theta&space;)&space;&&space;\cos&space;(\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$R(\theta&space;)=\left[&space;\begin{matrix}&space;\cos&space;(\theta&space;)&space;&&space;-\sin&space;(\theta&space;)&space;\\&space;\sin&space;(\theta&space;)&space;&&space;\cos&space;(\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" title="$R(\theta )=\left[ \begin{matrix} \cos (\theta ) & -\sin (\theta ) \\ \sin (\theta ) & \cos (\theta ) \\ \end{matrix} \right]$" /></a>, and we can turn this vector <a href="https://www.codecogs.com/eqnedit.php?latex=$\alpha&space;$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\alpha&space;$" title="$\alpha $" /></a> radians by multiply another rotation matrix. 

<a href="https://www.codecogs.com/eqnedit.php?latex=$R(\alpha&space;)R(\theta&space;)$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$R(\alpha&space;)R(\theta&space;)$" title="$R(\alpha )R(\theta )$" /></a>

<a href="https://www.codecogs.com/eqnedit.php?latex=$=\left[&space;\begin{matrix}&space;\cos&space;(\alpha&space;)&space;&&space;-\sin&space;(\alpha&space;)&space;\\&space;\sin&space;(\alpha&space;)&space;&&space;\cos&space;(\alpha&space;)&space;\\&space;\end{matrix}&space;\right]$$\left[&space;\begin{matrix}&space;\cos&space;(\theta&space;)&space;&&space;-\sin&space;(\theta&space;)&space;\\&space;\sin&space;(\theta&space;)&space;&&space;\cos&space;(\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$=\left[&space;\begin{matrix}&space;\cos&space;(\alpha&space;)&space;&&space;-\sin&space;(\alpha&space;)&space;\\&space;\sin&space;(\alpha&space;)&space;&&space;\cos&space;(\alpha&space;)&space;\\&space;\end{matrix}&space;\right]$$\left[&space;\begin{matrix}&space;\cos&space;(\theta&space;)&space;&&space;-\sin&space;(\theta&space;)&space;\\&space;\sin&space;(\theta&space;)&space;&&space;\cos&space;(\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" title="$=\left[ \begin{matrix} \cos (\alpha ) & -\sin (\alpha ) \\ \sin (\alpha ) & \cos (\alpha ) \\ \end{matrix} \right]$$\left[ \begin{matrix} \cos (\theta ) & -\sin (\theta ) \\ \sin (\theta ) & \cos (\theta ) \\ \end{matrix} \right]$" /></a>

<a href="https://www.codecogs.com/eqnedit.php?latex=$=\left[&space;\begin{matrix}&space;\cos&space;(\alpha&space;)\cos&space;(\theta&space;)-\sin&space;(\alpha&space;)\sin&space;(\theta&space;)&space;&&space;-(\cos&space;(\alpha&space;)\sin&space;(\theta&space;)&plus;\sin&space;(\alpha&space;)\cos&space;(\theta&space;))&space;\\&space;\sin&space;(\alpha&space;)\cos&space;(\theta&space;)&plus;\cos&space;(\alpha&space;)\sin&space;(\theta&space;)&space;&&space;-\sin&space;(\alpha&space;)\sin&space;(\theta&space;)&plus;\cos&space;(\alpha&space;)\cos&space;(\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$=\left[&space;\begin{matrix}&space;\cos&space;(\alpha&space;)\cos&space;(\theta&space;)-\sin&space;(\alpha&space;)\sin&space;(\theta&space;)&space;&&space;-(\cos&space;(\alpha&space;)\sin&space;(\theta&space;)&plus;\sin&space;(\alpha&space;)\cos&space;(\theta&space;))&space;\\&space;\sin&space;(\alpha&space;)\cos&space;(\theta&space;)&plus;\cos&space;(\alpha&space;)\sin&space;(\theta&space;)&space;&&space;-\sin&space;(\alpha&space;)\sin&space;(\theta&space;)&plus;\cos&space;(\alpha&space;)\cos&space;(\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" title="$=\left[ \begin{matrix} \cos (\alpha )\cos (\theta )-\sin (\alpha )\sin (\theta ) & -(\cos (\alpha )\sin (\theta )+\sin (\alpha )\cos (\theta )) \\ \sin (\alpha )\cos (\theta )+\cos (\alpha )\sin (\theta ) & -\sin (\alpha )\sin (\theta )+\cos (\alpha )\cos (\theta ) \\ \end{matrix} \right]$" /></a>

<a href="https://www.codecogs.com/eqnedit.php?latex=$=\left[&space;\begin{matrix}&space;\cos&space;(\alpha&space;&plus;\theta&space;)&space;&&space;-\sin&space;(\alpha&space;&plus;\theta&space;)&space;\\&space;\sin&space;(\alpha&space;&plus;\theta&space;)&space;&&space;\cos&space;(\alpha&space;&plus;\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$=\left[&space;\begin{matrix}&space;\cos&space;(\alpha&space;&plus;\theta&space;)&space;&&space;-\sin&space;(\alpha&space;&plus;\theta&space;)&space;\\&space;\sin&space;(\alpha&space;&plus;\theta&space;)&space;&&space;\cos&space;(\alpha&space;&plus;\theta&space;)&space;\\&space;\end{matrix}&space;\right]$" title="$=\left[ \begin{matrix} \cos (\alpha +\theta ) & -\sin (\alpha +\theta ) \\ \sin (\alpha +\theta ) & \cos (\alpha +\theta ) \\ \end{matrix} \right]$" /></a>

<a href="https://www.codecogs.com/eqnedit.php?latex=$=R(\alpha&space;&plus;\theta&space;)$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$=R(\alpha&space;&plus;\theta&space;)$" title="$=R(\alpha +\theta )$" /></a>

So, <a href="https://www.codecogs.com/eqnedit.php?latex=$R(\angle&space;A-\angle&space;B)=R(A)R(-B)$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$R(\angle&space;A-\angle&space;B)=R(A)R(-B)$" title="$R(\angle A-\angle B)=R(A)R(-B)$" /></a>. At last, the <a href="https://www.codecogs.com/eqnedit.php?latex=$\arctan&space;2$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\arctan&space;2$" title="$\arctan 2$" /></a> function is used to retrieve the angle, which is <a href="https://www.codecogs.com/eqnedit.php?latex=$\angle&space;A-\angle&space;B=\operatorname{atan}2(\sin&space;(\angle&space;A-\angle&space;B),\cos&space;(\angle&space;A-\angle&space;B))$" target="_blank"><img src="https://latex.codecogs.com/gif.latex?$\angle&space;A-\angle&space;B=\operatorname{atan}2(\sin&space;(\angle&space;A-\angle&space;B),\cos&space;(\angle&space;A-\angle&space;B))$" title="$\angle A-\angle B=\operatorname{atan}2(\sin (\angle A-\angle B),\cos (\angle A-\angle B))$" /></a>. 

The associated codes use above methods to provide a theoretical solution, and the way in Udacity is the most efficient. 

![image](Docs/Data1.PNG)

![image](Docs/Data2.PNG)

